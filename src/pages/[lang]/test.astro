---
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
    return [{ params: { lang: 'fr' } }, { params: { lang: 'en' } }];
}

const { lang } = Astro.params;

const previews = [
    {
        id: 'serpent',
        title: 'comme un serpent dans une flûte',
        poems: [
            ['Aujourd’hui j’ai l’humeur', 'd’un saute pleureur'],
            ['la cuillère dans le pot de fer', 'en finesse te réveillera'],
            ['bon ou mavais', 'voici des moments'],
        ],
    },
    {
        id: 'coquilles',
        title: 'des coquilles et des pépins',
        poems: [
            ['je racle la pluie', 'sur le bord du jour'],
            ['éventail ouvert', 'sur des jours de menthe'],
            ['je marche', 'dans le sable mou', 'l’ongle en étoile'],
        ],
    },
];

export const prerender = true;
---

<Layout title='Test Ligne Ondulée Sécurisée'>
    <div class='wrapper'>
        {
            previews.map((recueil, index) => (
                <div
                    class={`project ${index === 0 ? 'red' : 'blue'}`}
                    data-id={recueil.id}
                >
                    {recueil.title}
                </div>
            ))
        }
        <div class='preview'></div>
    </div>

    <style>
        .wrapper {
            display: flex;
            height: 100vh;
        }

        .project {
            width: 100px;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 14px;
            text-align: center;
        }

        .red {
            background: #f87171;
        }

        .blue {
            background: #60a5fa;
        }

        .preview {
            flex: 1;
            position: relative;
            background: #fde68a;
            overflow: hidden;
        }

        .wavy-line {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wavy-word {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            white-space: nowrap;
            line-height: 1;
            color: #1f2937;
            background: rgba(255, 255, 255, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transform-origin: left center;
            transition: transform 0.3s ease;
        }
    </style>

    <script type='module'>
        console.log('Script chargé');

        const previews = [
            {
                id: 'serpent',
                poems: [
                    ['Aujourd’hui j’ai l’humeur', 'd’un saute pleureur'],
                    [
                        'la cuillère dans le pot de fer',
                        'en finesse te réveillera',
                    ],
                    ['bon ou mavais', 'voici des moments'],
                ],
            },
            {
                id: 'coquilles',
                poems: [
                    ['je racle la pluie', 'sur le bord du jour'],
                    ['éventail ouvert', 'sur des jours de menthe'],
                    ['je marche', 'dans le sable mou', 'l’ongle en étoile'],
                ],
            },
        ];

        const previewWrapper = document.querySelector('.preview');
        const projects = document.querySelectorAll('.project');

        console.log('Preview wrapper:', previewWrapper);
        console.log('Projects:', projects);

        function createWavyLine(segments) {
            console.log('Création de la ligne ondulée avec:', segments);
            const container = document.createElement('div');
            container.classList.add('wavy-line');

            const previewRect = previewWrapper.getBoundingClientRect();
            const containerWidth = previewRect.width * 0.8;
            const containerHeight = previewRect.height * 0.8;

            container.style.width = `${containerWidth}px`;
            container.style.height = `${containerHeight}px`;
            container.style.top = '50%';
            container.style.left = '50%';
            container.style.transform = 'translate(-50%, -50%)';

            previewWrapper.innerHTML = '';
            previewWrapper.appendChild(container);

            let currentX = 0;
            let currentY = containerHeight / 2;
            const angles = [-15, -10, -5, 0, 5, 10, 15];

            segments.forEach((text) => {
                const span = document.createElement('span');
                span.textContent = text;
                span.classList.add('wavy-word');
                const angle = angles[Math.floor(Math.random() * angles.length)];
                span.style.transform = `rotate(${angle}deg)`;
                container.appendChild(span);

                // Positionner le mot après l'avoir ajouté au DOM
                requestAnimationFrame(() => {
                    const width = span.getBoundingClientRect().width;
                    const radians = angle * (Math.PI / 180);

                    if (currentX + width > containerWidth) {
                        currentX = 0;
                        currentY += 40;
                    }

                    span.style.left = `${currentX}px`;
                    span.style.top = `${currentY}px`;
                    currentX += width * Math.cos(radians) + 20;
                    currentY += width * Math.sin(radians) * 0.2;
                });
            });
        }

        projects.forEach((project) => {
            const id = project.dataset.id;
            console.log('Ajout des événements pour le projet:', id);

            project.addEventListener('mouseenter', () => {
                console.log('Mouse enter sur le projet:', id);
                const recueil = previews.find((r) => r.id === id);
                console.log('Recueil trouvé:', recueil);
                const poem =
                    recueil.poems[
                        Math.floor(Math.random() * recueil.poems.length)
                    ];
                console.log('Poème sélectionné:', poem);
                previewWrapper.innerHTML = '';
                createWavyLine(poem);
            });

            project.addEventListener('mouseleave', () => {
                console.log('Mouse leave sur le projet:', id);
                previewWrapper.innerHTML = '';
            });
        });
    </script>
</Layout>
